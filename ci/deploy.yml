

#### Deploy stage

deploy-parity-testnet:
  stage:                           deploy
  <<:                              *publish-refs
  variables:
    POLKADOT_CI_COMMIT_NAME:       "${CI_COMMIT_REF_NAME}"
    POLKADOT_CI_COMMIT_REF:        "${CI_COMMIT_SHORT_SHA}"
  allow_failure:                   true
  trigger:                         "parity/infrastructure/parity-testnet"

zombienet-tests-parachains-smoke-test:
  stage:                           deploy
  image:                           "${ZOMBIENET_IMAGE}"
  <<:                              *kubernetes-env
  <<:                              *zombienet-refs
  needs:
    - job:                         publish-polkadot-image
    - job:                         publish-malus-image
    - job:                         publish-adder-collator-image
  variables:
    GH_DIR:                        "https://github.com/paritytech/polkadot/tree/${CI_COMMIT_SHORT_SHA}/zombienet_tests/parachains"
  before_script:
    - echo "Zombie-net Tests Config"
    - echo "${ZOMBIENET_IMAGE}"
    - echo "${PARACHAINS_IMAGE_NAME} ${PARACHAINS_IMAGE_TAG}"
    - echo "${MALUS_IMAGE_NAME} ${MALUS_IMAGE_TAG}"
    - echo "${GH_DIR}"
    - export DEBUG=zombie,zombie::network-node
    - export ZOMBIENET_INTEGRATION_TEST_IMAGE=${PARACHAINS_IMAGE_NAME}:${PARACHAINS_IMAGE_TAG}
    - export MALUS_IMAGE=${MALUS_IMAGE_NAME}:${MALUS_IMAGE_TAG}
    - export COL_IMAGE="docker.io/paritypr/colander:4519" # The collator image is fixed
  script:
    - /home/nonroot/zombie-net/scripts/run-test-env-manager.sh
        --github-remote-dir="${GH_DIR}"
        --test="0001-parachains-smoke-test.feature"
  allow_failure:                   true
  retry: 2
  tags:
    - zombienet-polkadot-integration-test

zombienet-tests-malus-dispute-valid:
  stage:                           deploy
  image:                           "${ZOMBIENET_IMAGE}"
  <<:                              *kubernetes-env
  <<:                              *zombienet-refs
  needs:
    - job:                         publish-polkadot-image
    - job:                         publish-malus-image
    - job:                         publish-adder-collator-image
  variables:
    GH_DIR:                        "https://github.com/paritytech/polkadot/tree/${CI_COMMIT_SHORT_SHA}/node/malus/integrationtests"
  before_script:
    - echo "Zombie-net Tests Config"
    - echo "${ZOMBIENET_IMAGE_NAME}"
    - echo "${PARACHAINS_IMAGE_NAME} ${PARACHAINS_IMAGE_TAG}"
    - echo "${MALUS_IMAGE_NAME} ${MALUS_IMAGE_TAG}"
    - echo "${GH_DIR}"
    - export DEBUG=zombie*
    - export ZOMBIENET_INTEGRATION_TEST_IMAGE=${PARACHAINS_IMAGE_NAME}:${PARACHAINS_IMAGE_TAG}
    - export MALUS_IMAGE=${MALUS_IMAGE_NAME}:${MALUS_IMAGE_TAG}
    - export COL_IMAGE=${COLLATOR_IMAGE_NAME}:${COLLATOR_IMAGE_TAG}
  script:
    - /home/nonroot/zombie-net/scripts/run-test-env-manager.sh
        --github-remote-dir="${GH_DIR}"
        --test="0001-dispute-valid-block.feature"
  allow_failure:                   true
  retry: 2
  tags:
    - zombienet-polkadot-integration-test
